name: Build ARM64 Binary with ARM Runner

on:
  push:
    branches: [ main, master, dev ]
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    name: Build for Linux ARM64 (aarch64)

    steps:
      - name: 游닌 Checkout Repository
        uses: actions/checkout@v4

      - name: 游 Run Build on ARM64 Architecture
        # Esta es la acci칩n que sugeriste. Ejecutar치 los comandos de 'run' en un entorno aarch64.
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: jammy  # Usamos Ubuntu 22.04 (Jammy)

          # Los siguientes comandos se ejecutan DENTRO del entorno ARM64
          run: |
            # Instala las herramientas b치sicas necesarias
            apt-get update -y
            apt-get install -y python3-pip python3-venv

            # Crea y activa un entorno virtual de Python
            python3 -m venv .venv
            source .venv/bin/activate

            # Actualiza pip e instala las dependencias
            # Usamos el requirements.txt del proyecto y a침adimos pyinstaller + la correcci칩n de setuptools
            pip install --upgrade pip
            pip install 'setuptools<60' pyinstaller -r requirements.txt

            # Compila la aplicaci칩n. Todos estos comandos ya los hab칤amos descubierto:
            # --onefile: crea un solo binario.
            # --name lncrawl: nombra el ejecutable.
            # --paths .: soluciona el problema de importaci칩n.
            # lncrawl/main.py: es el script de entrada correcto.
            pyinstaller --onefile --name lncrawl --paths . lncrawl/main.py

      - name: 游닋 Upload Artifact
        # Este paso se ejecuta fuera del emulador, una vez que el binario ya est치 creado en la carpeta 'dist'
        uses: actions/upload-artifact@v4
        with:
          name: lightnovel-crawler-linux-arm64
          path: dist
